From 61463b405b815312e960348d9aef3f6b8262573d Mon Sep 17 00:00:00 2001
From: Maciej Kromer <makro@makro.alatek.com.pl>
Date: Fri, 3 Mar 2023 16:24:22 +0100
Subject: [PATCH] aldec_amp

---
 arch/riscv/dts/Makefile                      |  3 +-
 arch/riscv/dts/mpfs-tysom-m-amp.dts          | 94 ++++++++++++++++++++
 configs/aldec_tysom_m_mpfs250t_amp_defconfig | 20 +++++
 3 files changed, 116 insertions(+), 1 deletion(-)
 create mode 100644 arch/riscv/dts/mpfs-tysom-m-amp.dts
 create mode 100644 configs/aldec_tysom_m_mpfs250t_amp_defconfig

diff --git a/arch/riscv/dts/Makefile b/arch/riscv/dts/Makefile
index abdc9a658c..85868c4209 100644
--- a/arch/riscv/dts/Makefile
+++ b/arch/riscv/dts/Makefile
@@ -1,7 +1,8 @@
 # SPDX-License-Identifier: GPL-2.0+
 
 dtb-$(CONFIG_TARGET_AX25_AE350) += ae350_32.dtb ae350_64.dtb
-dtb-$(CONFIG_TARGET_ALDEC_TYSOM_M_MPFS250T) += mpfs-tysom-m.dtb
+dtb-$(CONFIG_TARGET_ALDEC_TYSOM_M_MPFS250T) += mpfs-tysom-m.dtb \
+mpfs-tysom-m-amp.dtb
 dtb-$(CONFIG_TARGET_ARIES_M100PFSEVP) += mpfs-m100pfsevp.dtb
 dtb-$(CONFIG_TARGET_MICROCHIP_ICICLE) += microchip-mpfs-icicle-kit.dtb \
 microchip-mpfs-icicle-kit-amp.dtb microchip-mpfs-icicle-kit-qspi-nor.dtb
diff --git a/arch/riscv/dts/mpfs-tysom-m-amp.dts b/arch/riscv/dts/mpfs-tysom-m-amp.dts
new file mode 100644
index 0000000000..8cd96b0b0f
--- /dev/null
+++ b/arch/riscv/dts/mpfs-tysom-m-amp.dts
@@ -0,0 +1,94 @@
+// SPDX-License-Identifier: GPL-2.0
+/*
+ * Original all-in-one devicetree:
+ * Copyright (C) 2020-2022 - Aldec
+ * Rewritten to use includes:
+ * Copyright (C) 2022-2023 - Conor Dooley <conor.dooley@microchip.com>
+ */
+
+/dts-v1/;
+
+#include "microchip-mpfs.dtsi"
+
+/* Clock frequency (in Hz) of the rtcclk */
+#define MTIMER_FREQ	1000000
+
+/ {
+	#address-cells = <2>;
+	#size-cells = <2>;
+	model = "Aldec TySOM-M-MPFS250T-REV2";
+	compatible = "aldec,tysom-m-mpfs250t-rev2", "microchip,mpfs";
+
+	aliases {
+		serial1 = &uart1;
+		ethernet0 = &mac1;
+	};
+
+	chosen {
+		stdout-path = "serial1:115200n8";
+	};
+
+	cpus {
+		timebase-frequency = <MTIMER_FREQ>;
+	};
+
+	ddrc_cache_lo: memory@80000000 {
+		device_type = "memory";
+		reg = <0x0 0x80000000 0x0 0x30000000>;
+		status = "okay";
+	};
+
+	ddrc_cache_hi: memory@1000000000 {
+		device_type = "memory";
+		reg = <0x10 0x0 0x0 0x40000000>;
+		status = "okay";
+	};
+};
+
+&refclk {
+	clock-frequency = <125000000>;
+};
+
+&cpu4 {
+	status = "disabled";
+};
+	
+&uart1 {
+	status = "okay";
+};
+
+&uart3 {
+	status = "disabled"
+};
+	
+&mmc {
+	status = "okay";
+	pinctrl-names = "default";
+	bus-width = <4>;
+	cap-mmc-highspeed;
+	mmc-ddr-3_3v;
+	max-frequency = <200000000>;
+	non-removable;
+	no-sd;
+	no-sdio;
+	voltage-ranges = <3300 3300>;
+};
+
+&mac0 {
+	phy-mode = "sgmii";
+	phy-handle = <&phy0>;
+};
+
+&mac1 {
+	status = "okay";
+	phy-mode = "sgmii";
+	phy-handle = <&phy1>;
+
+	phy0: ethernet-phy@0 {
+		reg = <0>;
+	};
+
+	phy1: ethernet-phy@1 {
+		reg = <1>;
+	};
+};
diff --git a/configs/aldec_tysom_m_mpfs250t_amp_defconfig b/configs/aldec_tysom_m_mpfs250t_amp_defconfig
new file mode 100644
index 0000000000..619029ee60
--- /dev/null
+++ b/configs/aldec_tysom_m_mpfs250t_amp_defconfig
@@ -0,0 +1,20 @@
+CONFIG_RISCV=y
+CONFIG_SYS_MALLOC_LEN=0x800000
+CONFIG_SYS_MALLOC_F_LEN=0x2000
+CONFIG_ENV_SIZE=0x2000
+CONFIG_ENV_OFFSET=0x4400
+CONFIG_DEFAULT_DEVICE_TREE="mpfs-tysom-m-amp"
+CONFIG_TARGET_ALDEC_TYSOM_M_MPFS250T=y
+CONFIG_ARCH_RV64I=y
+CONFIG_RISCV_SMODE=y
+CONFIG_SBI_V01=y
+CONFIG_DISTRO_DEFAULTS=y
+CONFIG_SYS_LOAD_ADDR=0x80200000
+CONFIG_FIT=y
+CONFIG_DISPLAY_CPUINFO=y
+CONFIG_DISPLAY_BOARDINFO=y
+CONFIG_ENV_OVERWRITE=y
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_SYS_RELOC_GD_ENV_ADDR=y
+CONFIG_BOOTP_SEND_HOSTNAME=y
+CONFIG_DM_MTD=y
-- 
2.34.1

