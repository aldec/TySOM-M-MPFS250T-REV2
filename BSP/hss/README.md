# Hart System Services

## Table of Content

- [Hardware Software Services code](#hardware_software_services_code)
    - [Operation](#operation)
    - [HSS as a ZSBL](#hss_as_zsbl)
    - [HSS as a FSBL](#hss_as_fsbl)
    - [Licenses](#licenses)
- [TySOM-M-MPFS250T HSS Patch](#hss_patch)
    - [Building](#building)
    - [Rebuilding](#rebuilding)
    - [Programming](#programming)

## Hardware Software Services code <a name="hardware_software_services_code"/>

Hart Software Services, commonly referred as “HSS”, is a collection of services that run on the E51 monitor core. HSS is used for the following:
- Program memory using USB mass storage.
- Copy a program (Linux or Bare Metal) from a non-volatile storage (for example, eMMC or SD card) to the LIM or DDR.
- Create a payload containing multiple applications to be booted and run.
- Pass messages between cores in the MSS.

### Operation <a name="operation"/>
The HSS uses Bare Metal drivers to initialize the system, which are found in the PolarFire SoC Bare Metal Library. It relies on XML generated by the PolarFire SoC MSS Configurator to configure the system on boot.
The HSS comprises of the following:
- A superloop monitor running on the E51 processor, which receives requests from the individual U54 application processors to perform certain services on their behalf.
- A Machine-Mode software interrupt trap handler, which allows the E51 to send messages to the U54s, and requests them to perform certain functions for it related to rebooting the U54.

### HSS as a ZSBL <a name="hss_as_zsbl"/>
The HSS can function as a Zero Stage Boot Loader (ZSBL) to boot Linux. In this case, the HSS loads U-Boot acting as a ZSBL with U-Boot subsequently loading an OS. U-Boot is a First Stage Boot Loader (FSBL) and a Second Stage Boot Loader (SSBL).

### HSS as a FSBL <a name="hss_as_fsbl"/>
The HSS can be used to boot Linux directly like the Berkeley Boot Loader (BBL) acting as an FSBL and SSBL.

### Licenses <a name="license"/>
This software is released under an MIT license. It also uses other open source tools. RISC-V OpenSBI is released under a BSD-2-Clause and FastLZ compression is released under an MIT license. More information on licensing can be found at: [HSS GitHub Repo](https://github.com/polarfire-soc/hart-software-services/blob/master/LICENSE.md).

## TySOM-M-MPFS250T HSS Patch <a name="hss_patch"/>

Aldec has patched [HSS](https://github.com/polarfire-soc/hart-software-services) repository with necessery changes for TySOM-M-MPFS250T board.  
- Patch version : 1.0
- HSS original repository fork commit: 58b03943834fe34991dc5fa924436b3620e07aa5
- SoftConsole v6.4

### Building <a name="building"/>

The build is configured using the Kconfig system of selecting build options.

Due to potential licensing issues, the Hart Software Services do not include Kconfig parsing infrastructure directly. Instead, install [Kconfiglib](https://github.com/ulfalizer/Kconfiglib) - available at [https://github.com/ulfalizer/Kconfiglib](https://github.com/ulfalizer/Kconfiglib).

Both Linux and Windows are supported by Kconfiglib. Kconfiglib is easily installed with pip from the Linux command line:

```
$ pip install kconfiglib
```

This step requires RISC-V cross compiler. It for example can be found inside the SoftConsole tool (SoftConsole-v2021.1/riscv-unknown-elf-gcc/bin). The cross compller should be added to system PATH (export PATH=<path to your cross compiller>:$PATH)
1. Change directory to version directory (v1_0), and execute ./hss.sh script. It will download HSS repo, checkout the specified commit, and patch it with Aldec HSS patch.
2. Change directory to hart-software-services and copy config file for TySOM-M-MPFS250T board

```
$ cd hart-software-services
```

```
$ cp boards/tysom-m-mpfs250t/def_config ./.config
```

3. Build

```
$ make BOARD=tysom-m-mpfs250t
```

After this step the hss.hex and hss.elf can be found within Default directory

### Rebuilding <a name="rebuilding"/>

HSS should be recompiled each time the PolarFire SoC MSS Configuration changed.
1. Replace the boards/tysom-m-mpfs250t/soc_fpga_design/xml/Aldec_MSSv2_mss_cfg.xml file with new configuration xml file generated using PolarFire SoC MSS Configurator.
2. Remove boards/tysom-m-mpfs250t/soc_config directory
3. Clean and make:

```
$ make BOARD=tysom-m-mpfs250t clean
```

```
$ make BOARD=tysom-m-mpfs250t
```

### Programming <a name="programming"/>

In order to program the board the FlashPro5 cable must be connected to the JTAG connector of TySOM-M MPFS250T board, and the board should be powered on.

Programming the board with HSS can be done in two ways:
1. Libero 2021.1 - hss.hex file can be added as a Boot Mode Client 1 to the eNVM memory during bitfile creation.
- In Libero Design Flow tab, after Generating FPGA Array Data of the design, click on the "Configure Design Initialization Data and Memories
- select eNVM tab add click Add Boot Mode Client 1, and select the hss.hex file.

The HSS will be inside the bitfile, and will run after board programming.

2. SoftConsole 6.4
- Start SoftConsole in its workspace (<SoftConsole>/extras/workspace.examples)
- Select File->Import, then existing project into workspace, and navigate to the previously downloaded HSS repo
- In order to program the board press Run->External Tools -> PolarFire SoC non-secure boot mode 1.
The SoftConsole will start programming the board.
