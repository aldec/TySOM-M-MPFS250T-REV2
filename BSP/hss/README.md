# Hart System Services

## Table of Contents

- [Hardware Software Services code](#hardware_software_services_code)
    - [Operation](#operation)
    - [HSS as a ZSBL](#hss_as_zsbl)
    - [HSS as a FSBL](#hss_as_fsbl)
    - [Licenses](#licenses)
- [TySOM-M-MPFS250T HSS Patch](#hss_patch)
    - [Building](#building)
    - [Rebuilding](#rebuilding)
    - [Programming](#programming)

## Hardware Software Services code <a name="hardware_software_services_code"/>

Hart Software Services, commonly referred to as “HSS”, is a collection of services that run on the E51 monitor core. HSS is used for the following:
- Programming memory using USB mass storage.
- Copying a program (Linux or Bare Metal) from a non-volatile storage (for example SD card) to the LIM or DDR.
- Creating a payload containing multiple applications to be booted and run.
- Passing messages between cores in the MSS.

### Operation <a name="operation"/>
HSS uses Bare Metal drivers to initialize the system, which are found in the PolarFire SoC Bare Metal Library. It relies on XML generated by the PolarFire SoC MSS Configurator to configure the system on boot. HSS comprises of the following:
- A superloop monitor running on the E51 processor, which receives requests from the individual U54 application processors to perform certain services on their behalf.
- A Machine-Mode software interrupt trap handler, which allows the E51 to send messages to the U54s, and requests them to perform certain functions for it related to rebooting the U54.

### HSS as a ZSBL <a name="hss_as_zsbl"/>
HSS can function as a Zero Stage Boot Loader (ZSBL) to boot Linux. In this case,
HSS acts as a ZSBL to load U-boot. U-boot then loads an OS, acting as a First Stage Boot Loader (FSBL) and a Second Stage Boot Loader (SSBL).

### HSS as a FSBL <a name="hss_as_fsbl"/>
Acting as an FSBL and SSBL, HSS can be used to boot Linux directly like the Berkeley Boot Loader.

### Licenses <a name="license"/>
This software is released under an MIT license. It also uses other open source tools. RISC-V OpenSBI is released under a BSD-2-Clause, and FastLZ compression is released under an MIT license. More information on licensing can be found here: [HSS GitHub Repo](https://github.com/polarfire-soc/hart-software-services/blob/master/LICENSE.md).

## TySOM-M-MPFS250T HSS Patch <a name="hss_patch"/>

Aldec has patched the [HSS](https://github.com/polarfire-soc/hart-software-services) repository with necessary changes for TySOM-M-MPFS250T board.  
- Patch version : 1.0
- HSS original repository fork commit: 58b03943834fe34991dc5fa924436b3620e07aa5
- SoftConsole v2021.3

### Building <a name="building"/>

The build is configured using the Kconfig system of selecting build options.

Due to potential licensing issues, Hart Software Services does not include Kconfig parsing infrastructure directly. [Kconfiglib](https://github.com/ulfalizer/Kconfiglib) will need to be installed, which can be found here:[https://github.com/ulfalizer/Kconfiglib](https://github.com/ulfalizer/Kconfiglib).

Both Linux and Windows are supported by Kconfiglib. Kconfiglib can be easily installed with pip from the Linux command line:

```
$ pip install kconfiglib
```

This step requires a RISC-V cross compiler. An instance where this compiler can be found is inside the SoftConsole tool (SoftConsole-v2021.3/riscv-unknown-elf-gcc/bin). Make sure that the cross compiler is added to system PATH (export PATH=<path to your cross compiller>:$PATH). Then:
1. Change directory to version directory (v1_0), and execute ./hss.sh script. This will download the HSS repo, checkout the specified commit, and patch it with the Aldec HSS patch.
2. Change directory to hart-software-services and copy config file for TySOM-M-MPFS250T board

```
$ cd hart-software-services
```

```
$ cp boards/tysom-m-mpfs250t/def_config ./.config
```

3. Build

```
$ make BOARD=tysom-m-mpfs250t
```

After this step, the .hex and .elf can be found within Default directory.

### Rebuilding <a name="rebuilding"/>

HSS should be recompiled each time the PolarFire SoC MSS Configuration has been changed. To recompile:
1. Replace the boards/tysom-m-mpfs250t/soc_fpga_design/xml/Aldec_2022_2_mss_cfg.xml file with the new configuration XML file generated using the PolarFire SoC MSS Configurator.
2. Remove boards/tysom-m-mpfs250t/soc_config directory.
3. Clean and make:

```
$ make BOARD=tysom-m-mpfs250t clean
```

```
$ make BOARD=tysom-m-mpfs250t
```

### Programming <a name="programming"/>

To program the board, the FlashPro5 or FlashPro6 cable must be connected to the JTAG connector of the TySOM-M MPFS250T board, and the board should be powered on.

Programming the board with HSS can be done in two ways:
1. Libero 2022.2 - hss.hex file can be added as a Boot Mode Client 1 to the eNVM memory during bitfile creation.
- In Libero Design Flow tab, after Generating FPGA Array Data of the design, click on "Configure Design Initialization Data and Memories".
- Select eNVM tab, click Add Boot Mode Client 1, and select the hss.hex file.
- The HSS will be inside the bitfile, and will run after board programming.

2. SoftConsole 2021.3
- Start SoftConsole in its workspace (<SoftConsole>/extras/workspace.examples).
- Select File->Import, then existing project into workspace, and navigate to the previously downloaded HSS repo.
- To program the board, press Run->External Tools -> PolarFire SoC non-secure boot mode 1.
- SoftConsole will start programming the board.
